<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>USMC Convoy Manifest Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; text-align: center; height: 100vh; overflow: hidden; }
        #splash { background-color: white; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #splash img { max-width: 300px; width: 80%; }
        #app { display: none; height: 100vh; overflow-y: auto; }
        h1 { color: #013220; }
        .screen { padding: 20px; max-width: 800px; margin: 0 auto; background: white; min-height: 100%; }
        button { background-color: #013220; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #024930; }
        button:disabled { background-color: #666; cursor: not-allowed; }
        input, select { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        label { display: block; margin: 5px 0; font-weight: bold; }
        .search-container { display: flex; align-items: center; margin-bottom: 20px; }
        #comm-search, #water-search, #fuel-search { flex: 1; }
        #add-search-btn, #add-water-btn, #add-fuel-btn { margin-left: 10px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #013220; color: white; }
        #comm-gear-added, #water-container-added, #fuel-container-added, #vehicles-added, #weapons-added { max-height: 400px; overflow-y: auto; }
        .add-row-btn { background-color: #013220; font-size: 16px; padding: 5px 10px; }
        .add-row-btn:hover { background-color: #024930; }
        .delete-btn { background-color: #a30000; padding: 5px 10px; }
        .delete-btn:hover { background-color: #cc0000; }
        .error-message { color: red; font-size: 12px; display: none; }
        #upload-section { margin-top: 10px; }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e7/Eagle%2C_Globe%2C_and_Anchor.svg/512px-Eagle%2C_Globe%2C_and_Anchor.svg.png" alt="USMC EGA">
        <h1>USMC Convoy Manifest Tool</h1>
        <p>Developed by [Your Name]</p>
    </div>

    <!-- Main App -->
    <div id="app">
        <!-- Initial Screen -->
        <div id="initial-screen" class="screen">
            <h1>Welcome to the USMC Convoy Manifest Tool</h1>
            <button id="new-user-btn">New User</button>
            <button id="returning-user-btn" disabled>Returning User</button>
        </div>

        <!-- New User Registration -->
        <div id="new-user-screen" class="screen" style="display: none;">
            <h1>New User Registration</h1>
            <form id="user-form">
                <label for="rank">Rank:</label>
                <input type="text" id="rank" name="rank" required>
                <label for="last-name">Last Name:</label>
                <input type="text" id="last-name" name="last-name" required>
                <label for="first-name">First Name:</label>
                <input type="text" id="first-name" name="first-name" required>
                <label for="billet">Billet:</label>
                <input type="text" id="billet" name="billet" required>
                <label for="unit">Unit:</label>
                <input type="text" id="unit" name="unit" required>
                <button type="submit">Submit</button>
            </form>
        </div>

        <!-- Options Screen -->
        <div id="options-screen" class="screen" style="display: none;">
            <h1>Convoy Management Options</h1>
            <button id="enter-vehicles-btn">Enter New Vehicles</button>
            <button id="enter-personnel-btn">Enter New Personnel</button>
            <button id="back-to-initial-btn">Back</button>
        </div>

        <!-- Enter Vehicles Screen -->
        <div id="vehicles-screen" class="screen" style="display: none;">
            <h1>Enter New Vehicles</h1>
            <button id="manual-add-btn">Manual Add</button>
            <div id="upload-section">
                <a href="data:text/csv;charset=utf-8,Category,Model,Code%2FTAMCN,Description,Serial%20Number%0AComm%20Gear,,Radio%20Type,,Serial%0AWater%20Containers,Code,Name,,Serial%0AFuel%20Containers,Code,Name,,Serial%0AVehicles,Model,TAMCN,Vehicle%20Description,Serial%0AWeapons%20Systems,Model,Code,Description,Serial" download="manifest_template.csv">Download Template</a>
                <br>
                <input type="file" id="spreadsheet-upload" accept=".csv">
                <button id="upload-spreadsheet-btn">Upload Spreadsheet</button>
            </div>
            <button id="back-to-options-btn">Back</button>
        </div>

        <!-- Manual Add Screen -->
        <div id="manual-add-screen" class="screen" style="display: none;">
            <h1>Manual Add Equipment</h1>
            <button id="add-comm-gear-btn">Add Comm Gear</button>
            <button id="add-water-containers-btn">Add Water Containers</button>
            <button id="add-fuel-containers-btn">Add Fuel Containers</button>
            <button id="add-vehicles-btn">Add Vehicles</button>
            <button id="add-weapons-btn">Add Weapons Systems</button>
            <button id="back-to-vehicles-btn">Back</button>
        </div>

        <!-- Add Comm Gear Screen (Input Style 2) -->
        <div id="add-comm-gear-screen" class="screen" style="display: none;">
            <h1>Add Comm Gear (Input Style 2)</h1>
            <div class="search-container">
                <input type="text" id="comm-search" placeholder="Search Radio Type" list="comm-suggestions">
                <datalist id="comm-suggestions"></datalist>
                <button id="add-search-btn">Add</button>
            </div>
            <table id="comm-gear-table">
                <thead>
                    <tr>
                        <th>Radio Type</th>
                        <th>Serial Number</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="comm-gear-added"></tbody>
            </table>
            <button id="save-comm-gear-btn">Save</button>
            <button id="back-to-manual-add-btn">Back</button>
        </div>

        <!-- Add Water Containers Screen (Input Style 2) -->
        <div id="add-water-containers-screen" class="screen" style="display: none;">
            <h1>Add Water Containers (Input Style 2)</h1>
            <div class="search-container">
                <input type="text" id="water-search" placeholder="Search Water Container" list="water-suggestions">
                <datalist id="water-suggestions"></datalist>
                <button id="add-water-btn">Add</button>
            </div>
            <table id="water-container-table">
                <thead>
                    <tr>
                        <th>Container Code</th>
                        <th>Name</th>
                        <th>Serial Number</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="water-container-added"></tbody>
            </table>
            <button id="save-water-btn">Save</button>
            <button id="back-to-manual-add-btn-water">Back</button>
        </div>

        <!-- Add Fuel Containers Screen (Input Style 2) -->
        <div id="add-fuel-containers-screen" class="screen" style="display: none;">
            <h1>Add Fuel Containers (Input Style 2)</h1>
            <div class="search-container">
                <input type="text" id="fuel-search" placeholder="Search Fuel Container" list="fuel-suggestions">
                <datalist id="fuel-suggestions"></datalist>
                <button id="add-fuel-btn">Add</button>
            </div>
            <table id="fuel-container-table">
                <thead>
                    <tr>
                        <th>Container Code</th>
                        <th>Name</th>
                        <th>Serial Number</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="fuel-container-added"></tbody>
            </table>
            <button id="save-fuel-btn">Save</button>
            <button id="back-to-manual-add-btn-fuel">Back</button>
        </div>

        <!-- Add Vehicles Screen (Input Style 1) -->
        <div id="add-vehicles-screen" class="screen" style="display: none;">
            <h1>Add Vehicles (Input Style 1)</h1>
            <table id="vehicles-table">
                <thead>
                    <tr>
                        <th>Model</th>
                        <th>TAMCN</th>
                        <th>Vehicle Description</th>
                        <th>Serial Number</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="vehicles-added"></tbody>
            </table>
            <button id="save-vehicles-btn">Save</button>
            <button id="back-to-manual-add-btn-vehicles">Back</button>
        </div>

        <!-- Add Weapons Systems Screen (Input Style 1) -->
        <div id="add-weapons-screen" class="screen" style="display: none;">
            <h1>Add Weapons Systems (Input Style 1)</h1>
            <table id="weapons-table">
                <thead>
                    <tr>
                        <th>Model</th>
                        <th>Code</th>
                        <th>Description</th>
                        <th>Serial Number</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="weapons-added"></tbody>
            </table>
            <button id="save-weapons-btn">Save</button>
            <button id="back-to-manual-add-btn-weapons">Back</button>
        </div>
    </div>

    <script>
        // Radio types for Comm Gear
        const radioTypes = [
            "AN/PRC-117F",
            "AN/PRC-117G",
            "AN/PRC-148 (MBITR)",
            "AN/PRC-150",
            "AN/PRC-152",
            "AN/PRC-154",
            "AN/PRC-155",
            "AN/PRC-163",
            "(MIDS) JTRS",
            "AN/PRC-119",
            "AN/PRC-153 (IISR)"
        ];

        // Water container data
        const waterContainerData = {
            "B2086": "SIXCON Water Storage Module",
            "D0880": "M149 Water Trailer ('Water Bull')",
            "D0882": "MTVR Water Trailer (MK149)"
        };

        // Fuel container data
        const fuelContainerData = {
            "B2085": "Fuel SIXCON",
            "D0211": "Flatrack Refueler",
            "D0215": "M970 Refueler"
        };

        // Vehicle data
        const vehicleData = {
            "D0003": "TRUCK, ARMORED, CARGO 7 TON, W/O WINCH NON-REDUCIBLE W/DFCS",
            "D0005": "TRUCK, ARMORED, XLWB CARGO, 7 TON, W/O WINCH, NON REDUCIBLE",
            "D0007": "TRUCK, ARMORED, DUMP 7-TON W/O WINCH NON-REDUCIBLE",
            "D0009": "TRUCK TRACTOR",
            "D0011": "CARRIER, TROOP, ARMORED, MTVR",
            "D0013": "TRUCK, ARMORED, TRACTOR, 7 TON, W/O WINCH, REDUCIBLE",
            "D0015": "TRUCK, ARMORED, WRECKER, 7 TON, W/WINCH REDUCIBLE",
            "D0016": "TRAILER, CARGO (LTT-H)",
            "D0022": "TRUCK, UTILITY: EXPANDED CAPACITY, ENHANCED, 11,500 GVW, 4X4, M1152, 2 DOOR",
            "D0026": "JLTV SHELTER AMBULANCE",
            "D0045": "GENERAL PURPOSE JOINT LIGHT TACTICAL VEHICLE (JLTV)",
            "D0046": "HVY GUNS CARRIER JLTV",
            "D0048": "UTILITY JLTV",
            "D0052": "LVSR, ARMORED CARGO VARIANT",
            "D0053": "LVSR, ARMORED TRACTOR VARIANT",
            "D0054": "LVSR, ARMORED WRECKER VARIANT",
            "D0187": "TRK, UTIL, HVY, 2 1/4T, HMMWV",
            "D0198": "TRUCK, CARGO, 7 TON, W/O WINCH",
            "D0886": "TRUCK CARGO 22.5 TON, 10X10, (LVSR)",
            "D0887": "TRUCK, TRACTOR, 10X10 (LVSR)",
            "D1001": "TRK, AMBUL, 4-LTR, ARMD, 2 1/4T, HMMWV",
            "D1002": "TRK, AMBUL, 2-LTR, SOFT TOP, 2 1/4T, HMMWV",
            "D1062": "TRUCK, CARGO, 7 TON, XLWB, W/ WINCH",
            "D1073": "TRUCK, DUMP, 7 TON, W/O WINCH",
            "D1158": "TRK, UTIL, CARGO/TRP CARR, 1 1/4T, W/EQP, HMMWV",
            "D1214": "TRUCK, WRECKER, 10X10 (LVSR)"
        };

        const vehicleModelNames = {
            "D0003": "MK23",
            "D0005": "MK25",
            "D0007": "MK29",
            "D0009": "MK31",
            "D0011": "MK27 or MK28 (Troop Carrier Variants)",
            "D0013": "MK31 (Tractor Variant)",
            "D0015": "MK36 Wrecker",
            "D0016": "M1102 (or LTT Trailer Series)",
            "D0022": "M1152 HMMWV",
            "D0026": "JLTV Ambulance Variant",
            "D0045": "JLTV GP",
            "D0046": "JLTV Heavy Guns Carrier Variant",
            "D0048": "JLTV Utility Variant",
            "D0052": "MKR18 Cargo",
            "D0053": "MKR16 Tractor",
            "D0054": "MKR15 Wrecker",
            "D0187": "M998 or M1151 HMMWV",
            "D0198": "MK23",
            "D0886": "MKR18 Cargo",
            "D0887": "MKR16 Tractor",
            "D1001": "M997 (Armored Ambulance)",
            "D1002": "M1035 (Soft Top Ambulance)",
            "D1062": "MK28",
            "D1073": "MK30",
            "D1158": "M1097 or M1152 HMMWV",
            "D1214": "MKR15 Wrecker"
        };

        // Weapons data
        const weaponsData = {
            "E0011": "M2 .50 Caliber Machine Gun",
            "E0178": "M240G 7.62mm Medium Machine Gun",
            "E0845": "MK19 40mm Grenade Machine Gun"
        };

        const weaponsModelNames = {
            "E0011": "M2",
            "E0178": "M240G",
            "E0845": "MK19"
        };

        // Screen management
        function showScreen(screenId) {
            document.querySelectorAll('#app .screen').forEach(screen => screen.style.display = 'none');
            document.getElementById(screenId).style.display = 'block';
        }

        // Splash screen transition
        setTimeout(() => {
            document.getElementById('splash').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        }, 5000);

        // Check for existing data
        const userData = JSON.parse(localStorage.getItem('userData')) || {};
        const commGear = JSON.parse(localStorage.getItem('commGear')) || [];
        const waterContainers = JSON.parse(localStorage.getItem('waterContainers')) || [];
        const fuelContainers = JSON.parse(localStorage.getItem('fuelContainers')) || [];
        const vehicles = JSON.parse(localStorage.getItem('vehicles')) || [];
        const weapons = JSON.parse(localStorage.getItem('weapons')) || [];
        if (Object.keys(userData).length > 0 || commGear.length > 0 || waterContainers.length > 0 || fuelContainers.length > 0 || vehicles.length > 0 || weapons.length > 0) {
            document.getElementById('returning-user-btn').disabled = false;
        }

        // Initial screen buttons
        document.getElementById('new-user-btn').addEventListener('click', () => showScreen('new-user-screen'));
        document.getElementById('returning-user-btn').addEventListener('click', () => alert('Returning user functionality coming soon!'));

        // New user form submission
        document.getElementById('user-form').addEventListener('submit', (event) => {
            event.preventDefault();
            const user = {
                rank: document.getElementById('rank').value,
                lastName: document.getElementById('last-name').value,
                firstName: document.getElementById('first-name').value,
                billet: document.getElementById('billet').value,
                unit: document.getElementById('unit').value
            };
            localStorage.setItem('userData', JSON.stringify(user));
            showScreen('options-screen');
        });

        // Options screen buttons
        document.getElementById('enter-vehicles-btn').addEventListener('click', () => showScreen('vehicles-screen'));
        document.getElementById('enter-personnel-btn').addEventListener('click', () => alert('Personnel entry coming soon!'));
        document.getElementById('back-to-initial-btn').addEventListener('click', () => showScreen('initial-screen'));

        // Vehicles screen buttons
        document.getElementById('manual-add-btn').addEventListener('click', () => showScreen('manual-add-screen'));
        document.getElementById('upload-spreadsheet-btn').addEventListener('click', handleSpreadsheetUpload);
        document.getElementById('back-to-options-btn').addEventListener('click', () => showScreen('options-screen'));

        // Manual add screen buttons
        document.getElementById('add-comm-gear-btn').addEventListener('click', () => {
            showScreen('add-comm-gear-screen');
            loadCommGearRows();
        });
        document.getElementById('add-water-containers-btn').addEventListener('click', () => {
            showScreen('add-water-containers-screen');
            loadWaterContainerRows();
        });
        document.getElementById('add-fuel-containers-btn').addEventListener('click', () => {
            showScreen('add-fuel-containers-screen');
            loadFuelContainerRows();
        });
        document.getElementById('add-vehicles-btn').addEventListener('click', () => {
            showScreen('add-vehicles-screen');
            loadVehicleRows();
        });
        document.getElementById('add-weapons-btn').addEventListener('click', () => {
            showScreen('add-weapons-screen');
            loadWeaponsRows();
        });
        document.getElementById('back-to-vehicles-btn').addEventListener('click', () => showScreen('vehicles-screen'));

        // Comm Gear (Input Style 2) logic
        const commSearchInput = document.getElementById('comm-search');
        const commSuggestions = document.getElementById('comm-suggestions');
        const commAddedTable = document.getElementById('comm-gear-added');

        radioTypes.forEach(type => {
            commSuggestions.innerHTML += `<option value="${type}"></option>`;
        });

        document.getElementById('add-search-btn').addEventListener('click', () => {
            const query = commSearchInput.value.trim().toUpperCase();
            const match = radioTypes.find(type => type.toUpperCase() === query);
            if (match) {
                commAddedTable.appendChild(createCommGearRow(match));
                commSearchInput.value = '';
            } else {
                alert('No matching radio type found. Please select from the suggestions.');
            }
        });

        function createCommGearRow(radioType, serial = '') {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${radioType}</td>
                <td>
                    <input type="text" class="serial-input" value="${serial}" placeholder="Enter Serial Number" required>
                    <div class="error-message">Missing Serial Number</div>
                </td>
                <td><button class="delete-btn">Delete</button></td>
            `;
            row.querySelector('.delete-btn').addEventListener('click', () => {
                row.remove();
            });
            return row;
        }

        function loadCommGearRows() {
            commAddedTable.innerHTML = '';
            const savedGear = JSON.parse(localStorage.getItem('commGear')) || [];
            savedGear.forEach(gear => commAddedTable.appendChild(createCommGearRow(gear.radioType, gear.serial)));
        }

        document.getElementById('save-comm-gear-btn').addEventListener('click', () => {
            const rows = commAddedTable.querySelectorAll('tr');
            const gearList = [];
            let allValid = true;
            rows.forEach(row => {
                const radioType = row.cells[0].textContent;
                const serialInput = row.querySelector('.serial-input');
                const serial = serialInput.value.trim();
                const errorMessage = row.querySelector('.error-message');
                if (serial) {
                    gearList.push({ radioType, serial });
                    errorMessage.style.display = 'none';
                } else {
                    allValid = false;
                    errorMessage.style.display = 'block';
                }
            });
            if (!allValid) {
                alert('Please enter serial numbers for all added items.');
            } else if (gearList.length > 0) {
                localStorage.setItem('commGear', JSON.stringify(gearList));
                alert('Comm Gear saved!');
                showScreen('manual-add-screen');
            } else {
                alert('No items to save.');
            }
        });

        // Water Containers (Input Style 2) logic
        const waterSearchInput = document.getElementById('water-search');
        const waterSuggestions = document.getElementById('water-suggestions');
        const waterAddedTable = document.getElementById('water-container-added');

        Object.entries(waterContainerData).forEach(([code, name]) => {
            waterSuggestions.innerHTML += `<option value="${code}">${name}</option>`;
        });

        document.getElementById('add-water-btn').addEventListener('click', () => {
            const query = waterSearchInput.value.trim().toUpperCase();
            const match = Object.keys(waterContainerData).find(code => code === query) || 
                         Object.values(waterContainerData).find(name => name.toUpperCase() === query);
            const code = Object.keys(waterContainerData).find(c => waterContainerData[c] === match || c === query);
            const name = waterContainerData[code];
            if (code && name) {
                waterAddedTable.appendChild(createWaterContainerRow(code, name));
                waterSearchInput.value = '';
            } else {
                alert('No matching water container found. Please select from the suggestions.');
            }
        });

        function createWaterContainerRow(code, name, serial = '') {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${code}</td>
                <td>${name}</td>
                <td>
                    <input type="text" class="serial-input" value="${serial}" placeholder="Enter Serial Number" required>
                    <div class="error-message">Missing Serial Number</div>
                </td>
                <td><button class="delete-btn">Delete</button></td>
            `;
            row.querySelector('.delete-btn').addEventListener('click', () => {
                row.remove();
            });
            return row;
        }

        function loadWaterContainerRows() {
            waterAddedTable.innerHTML = '';
            const savedContainers = JSON.parse(localStorage.getItem('waterContainers')) || [];
            savedContainers.forEach(container => waterAddedTable.appendChild(createWaterContainerRow(container.code, container.name, container.serial)));
        }

        document.getElementById('save-water-btn').addEventListener('click', () => {
            const rows = waterAddedTable.querySelectorAll('tr');
            const containerList = [];
            let allValid = true;
            rows.forEach(row => {
                const code = row.cells[0].textContent;
                const name = row.cells[1].textContent;
                const serialInput = row.querySelector('.serial-input');
                const serial = serialInput.value.trim();
                const errorMessage = row.querySelector('.error-message');
                if (serial) {
                    containerList.push({ code, name, serial });
                    errorMessage.style.display = 'none';
                } else {
                    allValid = false;
                    errorMessage.style.display = 'block';
                }
            });
            if (!allValid) {
                alert('Please enter serial numbers for all added items.');
            } else if (containerList.length > 0) {
                localStorage.setItem('waterContainers', JSON.stringify(containerList));
                alert('Water Containers saved!');
                showScreen('manual-add-screen');
            } else {
                alert('No items to save.');
            }
        });

        // Fuel Containers (Input Style 2) logic
        const fuelSearchInput = document.getElementById('fuel-search');
        const fuelSuggestions = document.getElementById('fuel-suggestions');
        const fuelAddedTable = document.getElementById('fuel-container-added');

        Object.entries(fuelContainerData).forEach(([code, name]) => {
            fuelSuggestions.innerHTML += `<option value="${code}">${name}</option>`;
        });

        document.getElementById('add-fuel-btn').addEventListener('click', () => {
            const query = fuelSearchInput.value.trim().toUpperCase();
            const match = Object.keys(fuelContainerData).find(code => code === query) || 
                         Object.values(fuelContainerData).find(name => name.toUpperCase() === query);
            const code = Object.keys(fuelContainerData).find(c => fuelContainerData[c] === match || c === query);
            const name = fuelContainerData[code];
            if (code && name) {
                fuelAddedTable.appendChild(createFuelContainerRow(code, name));
                fuelSearchInput.value = '';
            } else {
                alert('No matching fuel container found. Please select from the suggestions.');
            }
        });

        function createFuelContainerRow(code, name, serial = '') {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${code}</td>
                <td>${name}</td>
                <td>
                    <input type="text" class="serial-input" value="${serial}" placeholder="Enter Serial Number" required>
                    <div class="error-message">Missing Serial Number</div>
                </td>
                <td><button class="delete-btn">Delete</button></td>
            `;
            row.querySelector('.delete-btn').addEventListener('click', () => {
                row.remove();
            });
            return row;
        }

        function loadFuelContainerRows() {
            fuelAddedTable.innerHTML = '';
            const savedContainers = JSON.parse(localStorage.getItem('fuelContainers')) || [];
            savedContainers.forEach(container => fuelAddedTable.appendChild(createFuelContainerRow(container.code, container.name, container.serial)));
        }

        document.getElementById('save-fuel-btn').addEventListener('click', () => {
            const rows = fuelAddedTable.querySelectorAll('tr');
            const containerList = [];
            let allValid = true;
            rows.forEach(row => {
                const code = row.cells[0].textContent;
                const name = row.cells[1].textContent;
                const serialInput = row.querySelector('.serial-input');
                const serial = serialInput.value.trim();
                const errorMessage = row.querySelector('.error-message');
                if (serial) {
                    containerList.push({ code, name, serial });
                    errorMessage.style.display = 'none';
                } else {
                    allValid = false;
                    errorMessage.style.display = 'block';
                }
            });
            if (!allValid) {
                alert('Please enter serial numbers for all added items.');
            } else if (containerList.length > 0) {
                localStorage.setItem('fuelContainers', JSON.stringify(containerList));
                alert('Fuel Containers saved!');
                showScreen('manual-add-screen');
            } else {
                alert('No items to save.');
            }
        });

        // Vehicles (Input Style 1) logic
        function createVehicleRow(tamcn = '', model = '', description = '', serial = '') {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><select class="model-select">${Object.keys(vehicleModelNames).map(t => `<option value="${vehicleModelNames[t]}" ${vehicleModelNames[t] === model ? 'selected' : ''}>${vehicleModelNames[t]}</option>`).join('')}</select></td>
                <td><select class="tamcn-select">${Object.keys(vehicleData).map(t => `<option value="${t}" ${t === tamcn ? 'selected' : ''}>${t}</option>`).join('')}</select></td>
                <td><select class="description-select">${Object.values(vehicleData).map(d => `<option value="${d}" ${d === description ? 'selected' : ''}>${d}</option>`).join('')}</select></td>
                <td><input type="text" class="serial-input" value="${serial}" placeholder="Enter Serial Number" required></td>
                <td><button class="add-row-btn">+</button></td>
            `;
            const modelSelect = row.querySelector('.model-select');
            const tamcnSelect = row.querySelector('.tamcn-select');
            const descriptionSelect = row.querySelector('.description-select');
            const serialInput = row.querySelector('.serial-input');

            // Sync TAMCN to Model and Description
            tamcnSelect.addEventListener('change', () => {
                const selectedTamcn = tamcnSelect.value;
                modelSelect.value = vehicleModelNames[selectedTamcn] || '';
                descriptionSelect.value = vehicleData[selectedTamcn] || '';
            });

            // Sync Model to TAMCN and Description
            modelSelect.addEventListener('change', () => {
                const selectedModel = modelSelect.value;
                const matchingTamcn = Object.keys(vehicleModelNames).find(t => vehicleModelNames[t] === selectedModel);
                if (matchingTamcn) {
                    tamcnSelect.value = matchingTamcn;
                    descriptionSelect.value = vehicleData[matchingTamcn] || '';
                }
            });

            // Sync Description to TAMCN and Model
            descriptionSelect.addEventListener('change', () => {
                const selectedDescription = descriptionSelect.value;
                const matchingTamcn = Object.keys(vehicleData).find(t => vehicleData[t] === selectedDescription);
                if (matchingTamcn) {
                    tamcnSelect.value = matchingTamcn;
                    modelSelect.value = vehicleModelNames[matchingTamcn] || '';
                }
            });

            // Add row button with serial number check
            row.querySelector('.add-row-btn').addEventListener('click', () => {
                if (!serialInput.value.trim()) {
                    alert('Please enter a serial number before adding a new row.');
                } else {
                    document.getElementById('vehicles-added').appendChild(createVehicleRow());
                }
            });

            return row;
        }

        function loadVehicleRows() {
            const tbody = document.getElementById('vehicles-added');
            tbody.innerHTML = '';
            const savedVehicles = JSON.parse(localStorage.getItem('vehicles')) || [];
            if (savedVehicles.length > 0) {
                savedVehicles.forEach(vehicle => tbody.appendChild(createVehicleRow(vehicle.tamcn, vehicleModelNames[vehicle.tamcn], vehicle.description, vehicle.serial)));
            } else {
                tbody.appendChild(createVehicleRow());
            }
        }

        document.getElementById('save-vehicles-btn').addEventListener('click', () => {
            const rows = document.querySelectorAll('#vehicles-added tr');
            const vehicleList = [];
            let allValid = true;
            rows.forEach(row => {
                const tamcn = row.querySelector('.tamcn-select').value;
                const model = row.querySelector('.model-select').value;
                const description = row.querySelector('.description-select').value;
                const serial = row.querySelector('.serial-input').value.trim();
                if (tamcn && model && description && serial) {
                    vehicleList.push({ tamcn, model, description, serial });
                } else if (tamcn || model || description || serial) {
                    allValid = false;
                }
            });
            if (!allValid) {
                alert('Please complete all fields (Model, TAMCN, Description, and Serial Number) for each row.');
            } else if (vehicleList.length > 0) {
                localStorage.setItem('vehicles', JSON.stringify(vehicleList));
                alert('Vehicles saved!');
                showScreen('manual-add-screen');
            } else {
                alert('No valid entries to save.');
            }
        });

        // Weapons Systems (Input Style 1) logic
        function createWeaponsRow(code = '', model = '', description = '', serial = '') {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><select class="model-select">${Object.keys(weaponsModelNames).map(c => `<option value="${weaponsModelNames[c]}" ${weaponsModelNames[c] === model ? 'selected' : ''}>${weaponsModelNames[c]}</option>`).join('')}</select></td>
                <td><select class="code-select">${Object.keys(weaponsData).map(c => `<option value="${c}" ${c === code ? 'selected' : ''}>${c}</option>`).join('')}</select></td>
                <td><select class="description-select">${Object.values(weaponsData).map(d => `<option value="${d}" ${d === description ? 'selected' : ''}>${d}</option>`).join('')}</select></td>
                <td><input type="text" class="serial-input" value="${serial}" placeholder="Enter Serial Number" required></td>
                <td><button class="add-row-btn">+</button></td>
            `;
            const modelSelect = row.querySelector('.model-select');
            const codeSelect = row.querySelector('.code-select');
            const descriptionSelect = row.querySelector('.description-select');
            const serialInput = row.querySelector('.serial-input');

            // Sync Code to Model and Description
            codeSelect.addEventListener('change', () => {
                const selectedCode = codeSelect.value;
                modelSelect.value = weaponsModelNames[selectedCode] || '';
                descriptionSelect.value = weaponsData[selectedCode] || '';
            });

            // Sync Model to Code and Description
            modelSelect.addEventListener('change', () => {
                const selectedModel = modelSelect.value;
                const matchingCode = Object.keys(weaponsModelNames).find(c => weaponsModelNames[c] === selectedModel);
                if (matchingCode) {
                    codeSelect.value = matchingCode;
                    descriptionSelect.value = weaponsData[matchingCode] || '';
                }
            });

            // Sync Description to Code and Model
            descriptionSelect.addEventListener('change', () => {
                const selectedDescription = descriptionSelect.value;
                const matchingCode = Object.keys(weaponsData).find(c => weaponsData[c] === selectedDescription);
                if (matchingCode) {
                    codeSelect.value = matchingCode;
                    modelSelect.value = weaponsModelNames[matchingCode] || '';
                }
            });

            // Add row button with serial number check
            row.querySelector('.add-row-btn').addEventListener('click', () => {
                if (!serialInput.value.trim()) {
                    alert('Please enter a serial number before adding a new row.');
                } else {
                    document.getElementById('weapons-added').appendChild(createWeaponsRow());
                }
            });

            return row;
        }

        function loadWeaponsRows() {
            const tbody = document.getElementById('weapons-added');
            tbody.innerHTML = '';
            const savedWeapons = JSON.parse(localStorage.getItem('weapons')) || [];
            if (savedWeapons.length > 0) {
                savedWeapons.forEach(weapon => tbody.appendChild(createWeaponsRow(weapon.code, weaponsModelNames[weapon.code], weapon.description, weapon.serial)));
            } else {
                tbody.appendChild(createWeaponsRow());
            }
        }

        document.getElementById('save-weapons-btn').addEventListener('click', () => {
            const rows = document.querySelectorAll('#weapons-added tr');
            const weaponList = [];
            let allValid = true;
            rows.forEach(row => {
                const code = row.querySelector('.code-select').value;
                const model = row.querySelector('.model-select').value;
                const description = row.querySelector('.description-select').value;
                const serial = row.querySelector('.serial-input').value.trim();
                if (code && model && description && serial) {
                    weaponList.push({ code, model, description, serial });
                } else if (code || model || description || serial) {
                    allValid = false;
                }
            });
            if (!allValid) {
                alert('Please complete all fields (Model, Code, Description, and Serial Number) for each row.');
            } else if (weaponList.length > 0) {
                localStorage.setItem('weapons', JSON.stringify(weaponList));
                alert('Weapons Systems saved!');
                showScreen('manual-add-screen');
            } else {
                alert('No valid entries to save.');
            }
        });

        // Spreadsheet Upload Logic
        function handleSpreadsheetUpload() {
            const fileInput = document.getElementById('spreadsheet-upload');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a CSV file to upload.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                if (lines.length <= 1) {
                    alert('The CSV file is empty or invalid.');
                    return;
                }

                const headers = lines[0].split(',');
                if (headers[0] !== 'Category' || headers[1] !== 'Model' || headers[2] !== 'Code/TAMCN' || headers[3] !== 'Description' || headers[4] !== 'Serial Number') {
                    alert('Invalid CSV format. Please use the provided template.');
                    return;
                }

                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const row = lines[i].split(',');
                    if (row.length === 5) {
                        const [category, model, codeTamcn, description, serial] = row.map(cell => cell.trim());
                        if (category && serial) { // Require category and serial at minimum
                            data.push({ category, model, codeTamcn, description, serial });
                        }
                    }
                }

                if (data.length === 0) {
                    alert('No valid data found in the CSV file.');
                    return;
                }

                // Process and save data by category
                const commGearList = data.filter(item => item.category === 'Comm Gear').map(item => ({ radioType: item.description, serial: item.serial }));
                const waterContainersList = data.filter(item => item.category === 'Water Containers').map(item => ({ code: item.codeTamcn, name: item.description, serial: item.serial }));
                const fuelContainersList = data.filter(item => item.category === 'Fuel Containers').map(item => ({ code: item.codeTamcn, name: item.description, serial: item.serial }));
                const vehiclesList = data.filter(item => item.category === 'Vehicles').map(item => ({ tamcn: item.codeTamcn, model: item.model, description: item.description, serial: item.serial }));
                const weaponsList = data.filter(item => item.category === 'Weapons Systems').map(item => ({ code: item.codeTamcn, model: item.model, description: item.description, serial: item.serial }));

                if (commGearList.length > 0) localStorage.setItem('commGear', JSON.stringify(commGearList));
                if (waterContainersList.length > 0) localStorage.setItem('waterContainers', JSON.stringify(waterContainersList));
                if (fuelContainersList.length > 0) localStorage.setItem('fuelContainers', JSON.stringify(fuelContainersList));
                if (vehiclesList.length > 0) localStorage.setItem('vehicles', JSON.stringify(vehiclesList));
                if (weaponsList.length > 0) localStorage.setItem('weapons', JSON.stringify(weaponsList));

                alert('Spreadsheet data uploaded and saved successfully!');
                showScreen('vehicles-screen');
            };
            reader.readAsText(file);
        }

        document.getElementById('back-to-manual-add-btn-weapons').addEventListener('click', () => showScreen('manual-add-screen'));
        document.getElementById('back-to-manual-add-btn-vehicles').addEventListener('click', () => showScreen('manual-add-screen'));
        document.getElementById('back-to-manual-add-btn-water').addEventListener('click', () => showScreen('manual-add-screen'));
        document.getElementById('back-to-manual-add-btn-fuel').addEventListener('click', () => showScreen('manual-add-screen'));
        document.getElementById('back-to-manual-add-btn').addEventListener('click', () => showScreen('manual-add-screen'));
    </script>
</body>
</html>
